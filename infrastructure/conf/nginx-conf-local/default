
# enable rewrite logging for debugging
error_log /var/log/nginx/error.log notice;
# rewrite_log on;

server {
    #proxy_cache cache;
    #proxy_cache_valid 200 1s;

    # on the servers, the pages are served on 8080 then reverse proxied upstream
    listen 8080 default_server;
    listen [::]:8080 default_server;
    root /home/site/wwwroot/apps/web/dist;
    index index.html;

    server_name _;

    # redirect server error pages
    error_page   404  /404;

    # Disable .git directory
    location ~ /\.git {
        deny all;
        access_log off;
        log_not_found off;
    }

    location = /robots.txt {
        alias /home/site/wwwroot/infrastructure/conf/dev.robots.txt;
    }
    # Permanent redirects to avoid dead links
    location = /en/communities/digital-talent { return 301 https://www.canada.ca/en/government/system/digital-government/gcdigital-community.html; }
    location = /fr/communities/digital-talent { return 301 https://www.canada.ca/fr/gouvernement/systeme/gouvernement-numerique/collectivite-gcnumerique.html; }

    # permanent redirect within the same domain with relative path
    location = /en/talent/search {
        absolute_redirect off;
        return 301 /en/search;
    }
    location = /fr/talent/search {
        absolute_redirect off;
        return 301 /fr/search;
    }

    # Permanent redirect for IAP french vanity url
    location = /apprentis-autochtone-ti {
        absolute_redirect off;
        return 301 /fr/indigenous-it-apprentice;
    }

    # local auth
    location ^~ /oxauth {
        proxy_pass "http://mock-auth:8080";
        # Header X-Forwarded-Proto tells mock-oauth2-proxy to use Host for
        # urls in response from /oxauth/.well-known/openid-confifiguration
        #
        # See: https://github.com/navikt/mock-oauth2-server/pull/187
        proxy_set_header X-Forwarded-Proto http;
        proxy_set_header Host localhost:8000;
        break;
    }

    location / {
        # First attempt to serve request as file, then
        # as directory, then fall back to redirecting to index.html
        try_files $uri $uri/ $uri.html /index.html;
    }
}

