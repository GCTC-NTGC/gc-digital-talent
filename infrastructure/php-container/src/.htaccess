# This file is mounted in the php docker container for local testing.  Any changes to this file that need to be deployed to the servers (dev, UAT, prod) should be manually made in infrastructure/conf/deploy.htaccess also.

# Don't automatically add slash (with 301 redirect) if path matches a directory
DirectorySlash off

<IfModule mod_rewrite.c>
    RewriteEngine on

    # Strip trailing slash from all urls and redirect back to public url, unless already pointing to a public folder
    RewriteCond %{REQUEST_URI} ^/(.+)/$
    RewriteCond %{REQUEST_URI} !/public/$
    RewriteCond %{REQUEST_URI} !/dist/$
    RewriteCond %{REQUEST_URI} !/tc-report/_site/.*
    RewriteRule ^ %{ENV:APP_URL}/%1 [L,R=301]

    # For configuration of local development proxy at "/oxauth", see site
    # config at "mock-auth-proxy.apache-site.conf"

    # Rewrite api requests
    RewriteRule ^graphql-playground$ api/public/graphql-playground [L]
    RewriteRule ^graphql$ api/public/graphql [L]
    RewriteRule ^api(/(.*))?$ api/public/$2 [L]

    # Send api login request to api
    RewriteRule ^login$ api/public/login [L]
    RewriteRule ^register$ api/public/register [L]
    RewriteRule ^auth-callback$ api/public/auth-callback [L]
    RewriteRule ^refresh$ api/public/refresh [L]

    # Send admin requests to admin dist folder (with or without public/ path prefix).
    RewriteRule ^admin/public(/(.*))?$ frontend/admin/dist/$2 [L]
    RewriteRule ^admin(/(.*))?$ frontend/admin/dist/$2 [L]

    # Send localized admin requests also to admin dist folder
    RewriteRule ^(en|fr)/admin(/(.*))?$ frontend/admin/dist/$3 [L]

    # Send homepage requests to talentsearch dist folder
    RewriteRule ^$ frontend/talentsearch/dist/ [L]
    RewriteRule ^(en|fr)$ frontend/talentsearch/dist/ [L]

    # Send talent requests to talentsearch dist folder (with or without public/ path prefix).
    RewriteRule ^talent/public(/(.*))?$ frontend/talentsearch/dist/$2 [L]
    RewriteRule ^talent(/(.*))?$ frontend/talentsearch/dist/$2 [L]

    # Send localized talent requests also to talentsearch dist folder;
    RewriteRule ^(en|fr)/talent(/(.*))?$ frontend/talentsearch/dist/$3 [L]

    # Send user requests to talentsearch dist folder (with or without public/ path prefix).
    RewriteRule ^users/public(/(.*))?$ frontend/talentsearch/dist/$2 [L]
    RewriteRule ^users(/(.*))?$ frontend/talentsearch/dist/$2 [L]

    # Send localized user requests also to talentsearch dist folder;
    RewriteRule ^(en|fr)/users(/(.*))?$ frontend/talentsearch/dist/$3 [L]

    # Send search requests to talentsearch dist folder (with or without public/ path prefix).
    RewriteRule ^search/public(/(.*))?$ frontend/talentsearch/dist/$2 [L]
    RewriteRule ^search(/(.*))?$ frontend/talentsearch/dist/$2 [L]

    # Send localized search requests also to talentsearch dist folder;
    RewriteRule ^(en|fr)/search(/(.*))?$ frontend/talentsearch/dist/$3 [L]

    # Send logged-out requests to talentsearch dist folder (with or without public/ path prefix).
    RewriteRule ^logged-out/public(/(.*))?$ frontend/talentsearch/dist/$2 [L]
    RewriteRule ^logged-out(/(.*))?$ frontend/talentsearch/dist/$2 [L]

    # Send localized talent requests also to talentsearch dist folder;
    RewriteRule ^(en|fr)/logged-out(/(.*))?$ frontend/talentsearch/dist/$3 [L]

    # Send browse requests to talentsearch dist folder (with or without public/ path prefix).
    RewriteRule ^browse/public(/(.*))?$ frontend/talentsearch/dist/$2 [L]
    RewriteRule ^browse(/(.*))?$ frontend/talentsearch/dist/$2 [L]

    # Send localized talent requests also to talentsearch dist folder;
    RewriteRule ^(en|fr)/browse(/(.*))?$ frontend/talentsearch/dist/$3 [L]

    # Send 404s to talentsearch dist folder (with or without public/ path prefix).
    RewriteRule ^404/public(/(.*))?$ frontend/talentsearch/dist/$2 [L]
    RewriteRule ^404(/(.*))?$ frontend/talentsearch/dist/$2 [L]

    # Send localized 404 requests also to talentsearch dist folder;
    RewriteRule ^(en|fr)/404(/(.*))?$ frontend/talentsearch/dist/$3 [L]

    # Send support requests to talentsearch dist folder (with or without public/ path prefix).
    RewriteRule ^support/public(/(.*))?$ frontend/talentsearch/dist/$2 [L]
    RewriteRule ^support(/(.*))?$ frontend/talentsearch/dist/$2 [L]

    # Send localized support requests also to talentsearch dist folder;
    RewriteRule ^(en|fr)/support(/(.*))?$ frontend/talentsearch/dist/$3 [L]

    # Send localized create account requests also to talentsearch dist folder;
    RewriteRule ^(en|fr)/create-account(/(.*))?$ frontend/talentsearch/dist/$2 [L]

    # Send register requests to talentsearch dist folder (with or without public/ path prefix).
    RewriteRule ^register-info/public(/(.*))?$ frontend/talentsearch/dist/$2 [L]
    RewriteRule ^register-info(/(.*))?$ frontend/talentsearch/dist/$2 [L]

    # Send localized talent requests also to talentsearch dist folder;
    RewriteRule ^(en|fr)/register-info(/(.*))?$ frontend/talentsearch/dist/$3 [L]

    # Send login-info requests to talentsearch dist folder (with or without public/ path prefix).
    RewriteRule ^login-info/public(/(.*))?$ frontend/talentsearch/dist/$2 [L]
    RewriteRule ^login-info(/(.*))?$ frontend/talentsearch/dist/$2 [L]

    # Send localized talent requests also to talentsearch dist folder;
    RewriteRule ^(en|fr)/login-info(/(.*))?$ frontend/talentsearch/dist/$3 [L]

    # Indigenous Apprenticeship french vanity url
    RewriteRule ^apprenti-autochtonne-ti(/(.*))?$  %{ENV:APP_URL}/fr/indigenous-it-apprentice$1 [L,R=301]

    # Indigenous Apprenticeship routes
    RewriteRule ^indigenous-it-apprentice(/(.*))?$ frontend/indigenousapprenticeship/dist/$2 [L]
    RewriteRule ^(en|fr)/indigenous-it-apprentice(/(.*))?$ frontend/indigenousapprenticeship/dist/$3 [L]

    # PHP Info page for debugging
    RewriteRule ^phpinfo.php$ phpinfo.php [L]

    # Direct static site requests to index files
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_URI} ^/tc-report/_site/(.+)/?$
    RewriteCond %{REQUEST_URI} !\.html$
    RewriteRule ^ tc-report/_site/%1/index.html [L]

    # Send tc-report/assets requests to correct folder
    RewriteCond %{REQUEST_URI} ^/tc-report/assets/
    RewriteRule ^tc-report/assets/(.*)$ tc-report/_site/assets/$1 [L]

    # Send all other requests to /tc-report/_site
    RewriteCond %{REQUEST_URI} !^/tc-report/_site
    RewriteRule ^(.*)/?$ tc-report/_site/$1 [L]

    ErrorDocument 404 /404
</IfModule>

<IfModule mod_headers.c>
  # Security headers
  Header add X-Content-Type-Options nosniff
  Header add X-XSS-Protection "1; mode=block"
  Header add  Strict-Transport-Security "max-age=31536000; includeSubdomains;"
  Header add Cache-Control "max-age=31536000"
  Header add Pragma no-cache

  # Policy headers
  Header add Referrer-Policy "no-referrer-when-downgrade"
  #Header add Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://www.google-analytics.com https://www.googletagmanager.com https://tagmanager.google.com https://code.jquery.com https://cdn.datatables.net https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://html2canvas.hertzen.com https://stackpath.bootstrapcdn.com; img-src 'self' data: https://www.google-analytics.com https://ssl.gstatic.com https://www.gstatic.com https://www.gravatar.com https://images.unsplash.com; style-src 'self' 'unsafe-inline' https://tagmanager.google.com https://fonts.googleapis.com https://code.ionicframework.com https://cdn.datatables.net https://stackpath.bootstrapcdn.com https://cdnjs.cloudflare.com; font-src 'self' data: https://fonts.gstatic.com https://tagmanager.google.com https://code.ionicframework.com https://stackpath.bootstrapcdn.com; frame-src 'self'; object-src 'self'; connect-src 'self' https://api.github.com https://www.google-analytics.com;"
  Header add Feature-Policy "geolocation 'none'; midi 'none'; sync-xhr 'none'; microphone 'none'; camera 'none'; magnetometer 'none'; gyroscope 'none'; fullscreen 'self'; payment 'none';"
</IfModule>
