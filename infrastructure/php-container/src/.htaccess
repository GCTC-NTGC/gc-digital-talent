# Don't automatically add slash (with 301 redirect) if path matches a directory
DirectorySlash off

<IfModule mod_rewrite.c>
    RewriteEngine on

    # Strip trailing slash from all urls and redirect back to public url, unless already pointing to a public folder
    RewriteCond %{REQUEST_URI} ^/(.+)/$
    RewriteCond %{REQUEST_URI} !/public/$
    RewriteCond %{REQUEST_URI} !/dist/$
    RewriteRule ^ %{ENV:APP_URL}/%1 [L,R=301]

    # For configuration of local development proxy at "/oxauth", see site
    # config at "mock-auth-proxy.apache-site.conf"

    # Rewrite api requests
    RewriteRule ^graphql-playground$ api/public/graphql-playground [L]
    RewriteRule ^graphql$ api/public/graphql [L]

    # Send api login request to api
    RewriteRule ^login$ api/public/login [L]
    RewriteRule ^auth-callback$ api/public/auth-callback [L]
    RewriteRule ^refresh$ api/public/refresh [L]

    # Send admin requests to admin dist folder (with or without public/ path prefix).
    RewriteRule ^admin/public(/(.*))?$ frontend/admin/dist/$2 [L]
    RewriteRule ^admin(/(.*))?$ frontend/admin/dist/$2 [L]

    # Send localized admin requests also to admin dist folder
    RewriteRule ^(en|fr)/admin(/(.*))?$ frontend/admin/dist/$3 [L]

    # Send talent requests to talentsearch dist folder (with or without public/ path prefix).
    RewriteRule ^talent/public(/(.*))?$ frontend/talentsearch/dist/$2 [L]
    RewriteRule ^talent(/(.*))?$ frontend/talentsearch/dist/$2 [L]

    # Send localized talent requests also to talentsearch dist folder;
    RewriteRule ^(en|fr)/talent(/(.*))?$ frontend/talentsearch/dist/$3 [L]

    # Send browse requests to talentsearch dist folder (with or without public/ path prefix).
    RewriteRule ^browse/public(/(.*))?$ frontend/talentsearch/dist/$2 [L]
    RewriteRule ^browse(/(.*))?$ frontend/talentsearch/dist/$2 [L]

    # Send localized talent requests also to talentsearch dist folder;
    RewriteRule ^(en|fr)/browse(/(.*))?$ frontend/talentsearch/dist/$3 [L]

    # Indigenous Apprenticeship routes
    RewriteRule ^indigenous-it-apprentice(/(.*))?$ frontend/indigenousapprenticeship/dist/$2 [L]
    RewriteRule ^(en|fr)/indigenous-it-apprentice(/(.*))?$ frontend/indigenousapprenticeship/dist/$3 [L]

    # PHP Info page for debugging
    RewriteRule ^phpinfo.php$ phpinfo.php [L]

    # Send all other requests to /tc-report
    RewriteRule ^(.*)/?$ tc-report/$1 [L]
</IfModule>


<IfModule mod_headers.c>
  # Security headers
  Header add X-Content-Type-Options nosniff
  Header add X-XSS-Protection "1; mode=block"
  Header add  Strict-Transport-Security "max-age=31536000; includeSubdomains;"
  Header add Cache-Control "max-age=31536000"
  Header add Pragma no-cache

  # Policy headers
  Header add Referrer-Policy "no-referrer-when-downgrade"
  #Header add Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://www.google-analytics.com https://www.googletagmanager.com https://tagmanager.google.com https://code.jquery.com https://cdn.datatables.net https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://html2canvas.hertzen.com https://stackpath.bootstrapcdn.com; img-src 'self' data: https://www.google-analytics.com https://ssl.gstatic.com https://www.gstatic.com https://www.gravatar.com https://images.unsplash.com; style-src 'self' 'unsafe-inline' https://tagmanager.google.com https://fonts.googleapis.com https://code.ionicframework.com https://cdn.datatables.net https://stackpath.bootstrapcdn.com https://cdnjs.cloudflare.com; font-src 'self' data: https://fonts.gstatic.com https://tagmanager.google.com https://code.ionicframework.com https://stackpath.bootstrapcdn.com; frame-src 'self'; object-src 'self'; connect-src 'self' https://api.github.com https://www.google-analytics.com;"
  Header add Feature-Policy "geolocation 'none'; midi 'none'; sync-xhr 'none'; microphone 'none'; camera 'none'; magnetometer 'none'; gyroscope 'none'; fullscreen 'self'; payment 'none';"
</IfModule>
