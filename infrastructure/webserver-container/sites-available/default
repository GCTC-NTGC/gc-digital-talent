# enable rewrite logging for debugging
# error_log /var/log/nginx/error.log notice;
# rewrite_log on;

# allow substitutions of runtime variables
sub_filter_last_modified on;



server {
    #proxy_cache cache;
	#proxy_cache_valid 200 1s;
    listen 8000;
    listen [::]:8000;
    root /home/site/wwwroot;
    index  index.php index.html index.htm;
    server_name  localhost localhost;

    # location / {
    #     index  index.php index.html index.htm;
    # }

    # redirect server error pages to the static page /50x.html
    #
    # error_page   500 502 503 504  /50x.html;
    # location = /50x.html {
    #     root   /html/;
    # }

    # Disable .git directory
    location ~ /\.git {
        deny all;
        access_log off;
        log_not_found off;
    }

    # api
    location = /graphql {
        fastcgi_pass 127.0.0.1:9000;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME /home/site/api/public/index.php;
    }
    location = /graphql-playground {
        fastcgi_pass 127.0.0.1:9000;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME /home/site/api/public/index.php;
    }
    location = /login {
        fastcgi_pass 127.0.0.1:9000;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME /home/site/api/public/index.php;
    }
    location = /register {
        fastcgi_pass 127.0.0.1:9000;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME /home/site/api/public/index.php;
    }
    location = /auth-callback {
        fastcgi_pass 127.0.0.1:9000;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME /home/site/api/public/index.php;
    }
    location = /refresh {
        fastcgi_pass 127.0.0.1:9000;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME /home/site/api/public/index.php;
    }

    # root URI goes to talentsearch
    location / {
        root /home/site/wwwroot/talent;
    }

    # root URI with language code goes to talentsearch
    location ~ ^/(en|fr)/?$ {
        rewrite (en|fr) /talent/index.html?locale=$1 last;
        root /home/site/wwwroot;
    }

    location ~ ^/(en|fr)/talent {
        rewrite ^/(en|fr)/talent(/.+)?$ /index.html?locale=$1 last;
        root /home/site/wwwroot;
    }

    location ~ ^/talent {
        root /home/site/wwwroot;
    }

    location = /talent/config.html {
        env OAUTH_POST_LOGOUT_REDIRECT;
        sub_filter '<!--#echo var="OAUTH_POST_LOGOUT_REDIRECT" -->'  '${OAUTH_POST_LOGOUT_REDIRECT}';
        root /home/site/wwwroot;
    }


    # admin static site
    # location /admin {
    #     root /home/site/wwwroot;
    # }

    # IAP static site
    # location /indigenous-it-apprentice {
    #     root /home/site/wwwroot;
    # }

    # location ~ [^/]\.php(/|$) {
    #     fastcgi_split_path_info ^(.+?\.php)(/.*)$;
    #     if (!-f $document_root$fastcgi_script_name) {
    #         return 404;
    #     }

    #     # Mitigate https://httpoxy.org/ vulnerabilities
    #     fastcgi_param HTTP_PROXY "";

    #     fastcgi_pass 127.0.0.1:9000;
    #     fastcgi_index index.php;

    #     # include the fastcgi_param setting
    #     include fastcgi_params;

    #     # SCRIPT_FILENAME parameter is used for PHP FPM determining
    #     #  the script name. If it is not set in fastcgi_params file,
    #     # i.e. /etc/nginx/fastcgi_params or in the parent contexts,
    #     # please comment off following line:
    #     # fastcgi_param  SCRIPT_FILENAME   $document_root$fastcgi_script_name;
    # }

    # Add locations of phpmyadmin here.
    # location ~ [^/]\.php(/|$) {
    #     fastcgi_split_path_info ^(.+?\.php)(|/.*)$;
    #     fastcgi_pass 127.0.0.1:9000;
    #     include fastcgi_params;
    #     fastcgi_param HTTP_PROXY "";
    #     fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    #     fastcgi_param PATH_INFO $fastcgi_path_info;
    #     fastcgi_param QUERY_STRING $query_string;
    #     fastcgi_intercept_errors on;
    #     fastcgi_connect_timeout         300;
    #     fastcgi_send_timeout           3600;
    #     fastcgi_read_timeout           3600;
    #     fastcgi_buffer_size 128k;
    #     fastcgi_buffers 4 256k;
    #     fastcgi_busy_buffers_size 256k;
    #     fastcgi_temp_file_write_size 256k;
    # }

}

